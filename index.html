<!DOCTYPE html>
<html>
  <head>
    <title>OpenAI API Key Checker</title>
    <meta charset="UTF-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <link rel="stylesheet" href="output.css" />
    <script src="openai.js"></script>
  </head>

  <body class="flex h-screen w-screen items-center justify-center bg-gradient-to-br from-white to-gray-200">
    <!-- 卡片外框 -->
    <div class="w-1/2 rounded-lg bg-white md:w-1/2 lg:w-1/2 xl:w-1/3">
      <!-- 卡片内框 -->
      <div class="flex h-auto flex-col items-center justify-center p-8">
        <!-- 标题栏 -->
        <div class="w-full rounded-tl-lg rounded-tr-lg bg-white px-2 pb-2 pt-2 text-left text-2xl font-bold">OpenAI API Key Checker</div>
        <!-- api输入部分 -->
        <div class="inline-flex w-full items-center px-2 pb-1">
          <div class="mr-6" for="api-key">API Key:</div>
          <input
            class="mr-3 h-10 flex-1 rounded-md border border-gray-400 px-2 hover:border-purple-500 focus:border-purple-500 focus:outline-none"
            placeholder="请输入您的API密钥：sk-"
            type="text"
            id="api-key"
            name="api-key"
            autocomplete="on"
          />
          <!-- 按钮 -->
          <button
            onclick="checkUsage()"
            class="my-2.5 inline-flex rounded border border-purple-200 bg-purple-600 px-4 py-2 font-bold text-white hover:border-transparent hover:bg-purple-600 hover:text-white focus:outline-none focus:ring-2 focus:ring-purple-600 focus:ring-offset-2"
          >
            <span id="loading-indicator" class="hidden">
              <svg class="mr-3 h-5 w-5 animate-spin" viewBox="0 0 24 24">
                <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                <path
                  class="stroke-current opacity-75"
                  fill="none"
                  stroke-dasharray="calc(2 * 3.14 * 10 * 0.25) calc(2 * 3.14 * 10)"
                  stroke-dashoffset="0"
                  stroke-linecap="round"
                  stroke-width="4"
                  d="M 12 2 A 10 10 0 0 0 12 22"
                ></path>
              </svg>
            </span>
            <span id="button-text">Check</span>
          </button>
        </div>

        <!-- 账户信息展示 -->
        <div id="account-info" class="flex w-full flex-col px-2 pb-1">
          <div id="account-name"></div>
          <div id="account-plan"></div>
          <div id="usage"></div>
          <div id="expiration-time"></div>
        </div>
        <!-- 图表 -->
        <canvas id="usage-chart" class="hidden"></canvas>
      </div>
    </div>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script>
      <!-- 定义一个名为 checkUsage 的函数 -->
      function checkUsage() {
        // 显示加载指示器
        const loadingIndicator = document.getElementById("loading-indicator");
        loadingIndicator.classList.remove("hidden");

        // 获取文本框中输入的 API Key 值
        var apiKey = document.getElementById("api-key").value;

        // 获取账户信息展示部分的元素id
        var accountName = document.getElementById("account-name");
        var accountPlan = document.getElementById("account-plan");
        var usage = document.getElementById("usage");
        var expirationTime = document.getElementById("expiration-time");

        // 调用 checkBill 函数，并使用 Promise 处理返回结果
        checkBill(apiKey)
          .then((data) => {
            //加载指示器消失
            const loadingIndicator = document.getElementById("loading-indicator");
            loadingIndicator.classList.add("hidden");
            //将图表显示到页面上
            usage.classList.remove("hidden");

            // 将获取到的数据显示在页面上的账户信息展示部分
            accountName.innerHTML = "Account Name: " + data[3].account_name;
            accountPlan.innerHTML = "Plans: " + data[3].hard_limit_usd;
            usage.innerHTML = "Remaining Requests: " + data[2].toFixed(2) + "$";

            // 处理到期时间
            let dateString = new Date(data[3].access_until * 1000);
            dateString = dateString.toISOString().substr(0, 10);
            expirationTime.innerHTML = "Expiration Time: " + dateString;

            // 获取 id 为 usage-chart 的元素，绘制图表
            var usageChart = document.getElementById("usage-chart").getContext("2d");
            var myChart = new Chart(usageChart, {
              type: "bar",
              data: {
                labels: ["Remaining Requests", "Used Requests"],
                datasets: [
                  {
                    label: "API Usage",
                    data: [data[2], data[1]],
                    backgroundColor: ["rgba(54, 162, 235, 0.2)", "rgba(255, 99, 132, 0.2)"],
                    borderColor: ["rgba(54, 162, 235, 1)", "rgba(255, 99, 132, 1)"],
                    borderWidth: 1,
                  },
                ],
              },
              options: {
                scales: {
                  yAxes: [
                    {
                      ticks: {
                        beginAtZero: true,
                      },
                    },
                  ],
                },
              },
            });
          })
          .catch((err) => {
            // 处理 Promise 执行失败的情况
            console.error("查询数据失败", err);
          });
      }
    </script>
  </body>
</html>
